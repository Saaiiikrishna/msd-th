# Auth Service with Keycloak Integration

This service provides authentication and authorization using Keycloak as the identity provider, aligned with the MySillyDreams treasure hunt architecture.

## Architecture Overview

### Separation of Concerns

- **Keycloak**: Handles authentication credentials, password management, and JWT token issuance
- **Auth Service**: Lightweight wrapper providing session introspection and coordinating user registration
- **User Service**: Handles ALL comprehensive user data (profiles, addresses, consents, etc.)
- **JWT Tokens**: Used for stateless authentication across services
- **Redis**: Caching for token introspection results

### Data Flow

1. **User Registration**: Auth Service creates credentials in Keycloak AND profile in User Service
2. **Authentication**: Keycloak issues JWT tokens with user_ref claim
3. **Authorization**: API Gateway uses Auth Service to introspect tokens and extract user_ref
4. **User Data**: All services use user_ref to interact with User Service for comprehensive user data

## Quick Start

### 1. Start Keycloak and Dependencies

```bash
cd auth-service
docker-compose -f docker-compose-keycloak.yml up -d
```

This starts:

- Keycloak on port 8080
- PostgreSQL database for Keycloak on port 5433
- Redis for caching on port 6379

### 2. Configure Keycloak Realm

1. Access Keycloak Admin Console: http://localhost:8080
2. Login with admin/admin
3. Create a new realm called "treasure-hunt"
4. Create a client called "auth-service" with:
   - Client authentication: ON
   - Authorization: OFF
   - Standard flow: ON
   - Direct access grants: ON

### 3. Start Auth Service

```bash
./gradlew bootRun
```

The service will start on port 8082 and automatically initialize the realm with default roles.

## API Endpoints

### User Registration

```http
POST /v1/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePassword123",
  "firstName": "John",
  "lastName": "Doe"
}
```

### JWT Token Validation

The system uses **direct JWT validation** with OAuth2 Resource Server configuration. No introspection endpoints are needed as all services validate JWT tokens directly against Keycloak's JWK endpoint.

**JWT Configuration:**

```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/treasure-hunt
          jwk-set-uri: http://localhost:8080/realms/treasure-hunt/protocol/openid-connect/certs
```

### Health Check

```http
GET /v1/health
```

## Configuration

Key configuration properties in `application.yml`:

```yaml
keycloak:
  realm: treasure-hunt
  auth-server-url: http://localhost:8080
  resource: auth-service
  credentials:
    secret: your-client-secret

spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/treasure-hunt
```

## Integration with Other Services

### API Gateway

The API Gateway validates JWT tokens directly using OAuth2 Resource Server configuration. It extracts user information including user_ref from the JWT claims without requiring introspection calls.

### User Service Integration

- **Registration Flow**: Auth Service creates user in Keycloak AND calls User Service to create comprehensive profile
- **Data Separation**: Keycloak stores only authentication credentials, User Service stores all other user data
- **user_ref**: UUID generated by Auth Service and used consistently across both systems
- **Rollback**: If User Service profile creation fails, Keycloak user is automatically deleted

### Other Services

All other services (Treasure, Payment) use user_ref from JWT tokens to interact with User Service for user data.

## Default Roles

The service automatically creates these roles in Keycloak:

- `ROLE_CUSTOMER`: Default role for registered users
- `ROLE_ADMIN`: Administrator role
- `ROLE_INTERNAL_CONSUMER`: For service-to-service communication

## Security Features

- JWT token validation using Keycloak's public keys
- Role-based access control
- Token introspection caching (5 minutes TTL)
- Secure password policies enforced by Keycloak
- Session management handled by Keycloak

## Monitoring

- Health endpoint: `/v1/health`
- Actuator endpoints: `/actuator/health`, `/actuator/info`
- Prometheus metrics: `/actuator/prometheus`

## Development

### Running Tests

```bash
./gradlew test
```

### Building Docker Image

```bash
./gradlew bootBuildImage
```

## Troubleshooting

### Common Issues

1. **Keycloak connection failed**: Ensure Keycloak is running and accessible
2. **JWT validation failed**: Check that the realm and client configuration match
3. **Role assignment failed**: Verify that the default roles exist in Keycloak

### Logs

Check application logs for detailed error information:

```bash
docker-compose -f docker-compose-keycloak.yml logs auth-service
```
